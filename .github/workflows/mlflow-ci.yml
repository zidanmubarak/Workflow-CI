name: MLflow CI/CD - Advanced

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Check Environment
        run: |
          python --version
          pip --version
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install mlflow scikit-learn pandas numpy matplotlib seaborn joblib
      
      - name: Set MLflow Tracking URI
        run: |
          echo "MLFLOW_TRACKING_URI=file:///tmp/mlruns" >> $GITHUB_ENV
      
      - name: Run MLflow Project
        run: |
          cd MLProject
          mlflow run . \
            --env-manager=local \
            -P data_path=climate_change_preprocessing.csv \
            -P n_estimators=100 \
            -P max_depth=10 \
            -P test_size=0.2 \
            -P random_state=42
      
      - name: Get latest MLflow run ID
        id: get_run_id
        run: |
          cd MLProject
          RUN_ID=$(python -c "
          import mlflow
          import os
          os.environ['MLFLOW_TRACKING_URI'] = 'file:///tmp/mlruns'
          client = mlflow.tracking.MlflowClient()
          experiment = client.get_experiment_by_name('Default')
          if experiment:
              runs = client.search_runs(experiment.experiment_id, order_by=['start_time DESC'], max_results=1)
              if runs:
                  print(runs[0].info.run_id)
          ")
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Latest MLflow Run ID: $RUN_ID"
      
      - name: Install Python dependencies for artifact collection
        run: |
          pip install mlflow
      
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cd MLProject
          
          # Copy model artifacts
          if [ -d "model" ]; then
            cp -r model ../artifacts/
          fi
          
          # Copy visualization artifacts
          if [ -f "confusion_matrix.png" ]; then
            cp confusion_matrix.png ../artifacts/
          fi
          if [ -f "feature_importance.png" ]; then
            cp feature_importance.png ../artifacts/
          fi
          if [ -f "classification_report.txt" ]; then
            cp classification_report.txt ../artifacts/
          fi
          
          # Copy MLflow artifacts
          if [ -d "/tmp/mlruns" ]; then
            cp -r /tmp/mlruns ../artifacts/
          fi
          
          ls -la ../artifacts/
      
      - name: Upload artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-${{ github.run_number }}
          path: artifacts/
          retention-days: 30
      
      - name: Build Docker Image
        run: |
          cd MLProject
          
          # Create Flask serving script
          cat > serve_model.py <<'PYEOF'
          from flask import Flask, request, jsonify
          import joblib
          import numpy as np
          import os
          
          app = Flask(__name__)
          
          # Load model
          MODEL_PATH = 'model/random_forest_model.pkl'
          model = None
          
          try:
              model = joblib.load(MODEL_PATH)
              print(f"✅ Model loaded from {MODEL_PATH}")
          except Exception as e:
              print(f"❌ Error loading model: {e}")
          
          @app.route('/')
          def home():
              return jsonify({
                  'service': 'Climate Change ML Model',
                  'status': 'running',
                  'model_loaded': model is not None,
                  'endpoints': {
                      '/': 'Home',
                      '/health': 'Health check',
                      '/predict': 'Make prediction (POST)'
                  }
              })
          
          @app.route('/health')
          def health():
              return jsonify({
                  'status': 'healthy',
                  'model_loaded': model is not None
              })
          
          @app.route('/predict', methods=['POST'])
          def predict():
              if model is None:
                  return jsonify({'error': 'Model not loaded'}), 500
              
              try:
                  data = request.get_json()
                  if not data or 'features' not in data:
                      return jsonify({'error': 'Invalid input'}), 400
                  
                  features = np.array(data['features']).reshape(1, -1)
                  prediction = model.predict(features)[0]
                  probability = model.predict_proba(features)[0]
                  
                  return jsonify({
                      'prediction': int(prediction),
                      'prediction_label': 'High Yield' if prediction == 1 else 'Low Yield',
                      'probability': {
                          'low_yield': float(probability[0]),
                          'high_yield': float(probability[1])
                      }
                  })
              except Exception as e:
                  return jsonify({'error': str(e)}), 500
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=5000)
          PYEOF
          
          # Create Dockerfile for model serving
          cat > Dockerfile <<'EOF'
          FROM python:3.10-slim
          
          WORKDIR /app
          
          # Install system dependencies
          RUN apt-get update && apt-get install -y --no-install-recommends \
              build-essential \
              curl \
              && rm -rf /var/lib/apt/lists/*
          
          # Install Python dependencies
          RUN pip install --no-cache-dir \
              flask \
              scikit-learn \
              pandas \
              numpy \
              joblib
          
          # Copy all files
          COPY . /app/
          
          # Expose Flask port
          EXPOSE 5000
          
          # Health check
          HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
            CMD curl -f http://localhost:5000/health || exit 1
          
          # Run Flask server
          CMD ["python", "serve_model.py"]
          EOF
          
          # Build Docker image
          docker build -t climate-change-ml .
          
          echo "✅ Docker image built successfully"
      
      - name: Log in to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Tag Docker Image
        if: github.event_name == 'push'
        run: |
          docker tag climate-change-ml ${{ secrets.DOCKER_USERNAME }}/climate-change-ml:latest
          docker tag climate-change-ml ${{ secrets.DOCKER_USERNAME }}/climate-change-ml:${{ github.run_number }}
      
      - name: Push Docker Image
        if: github.event_name == 'push'
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/climate-change-ml:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/climate-change-ml:${{ github.run_number }}
      
      - name: Post Log in to Docker Hub
        if: always()
        run: echo "Docker operations completed"
      
      - name: Summary
        if: always()
        run: |
          echo "==================================="
          echo "MLflow CI/CD Pipeline Summary"
          echo "==================================="
          echo "Status: Completed"
          echo "Run Number: ${{ github.run_number }}"
          echo "MLflow Run ID: ${{ steps.get_run_id.outputs.run_id }}"
          echo "Docker Image: ${{ secrets.DOCKER_USERNAME }}/climate-change-ml:latest"
          echo "==================================="
